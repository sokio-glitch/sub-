name: Build LobeChat for Termux (Fixed)

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 1

      # 2. ç¯å¢ƒå‡†å¤‡
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false

      - name: Install Dependencies
        run: pnpm install

      # 3. å…³é”®ä¿®å¤ï¼šæ›¿æ¢è¿‡æ—¶çš„ç¯å¢ƒå˜é‡
      - name: Build Standalone
        run: pnpm build
        env:
          NEXT_OUTPUT: standalone
          # ä¾ç„¶ä¿ç•™è·³è¿‡éªŒè¯ï¼Œé˜²æ­¢æ ¡éªŒæ•°æ®åº“è¿æ¥
          SKIP_ENV_VALIDATION: true
          
          # --- ä¿®å¤éƒ¨åˆ† START ---
          # âŒ å¿…é¡»åˆ é™¤: NEXT_AUTH_SECRET (ä¼šå¯¼è‡´æ„å»ºå¤±è´¥)
          # âœ… æ–°å¢: LobeChat v2 ä½¿ç”¨ LOBE_AUTH_SECRET ä½œä¸ºä¸»å¯†é’¥
          LOBE_AUTH_SECRET: "dummy_secret_for_build_process_32_chars_long"
          # --- ä¿®å¤éƒ¨åˆ† END ---

          # æä¾›å…¶ä»–å¿…è¦çš„å‡å˜é‡
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/lobe"
          KEY_VAULTS_SECRET: "dummy_secret_for_build_process"
          APP_URL: "http://localhost:3000"

      # 4. æ‰“åŒ…å¤„ç† (é’ˆå¯¹ Termux çš„ç‰¹æ®Šå¤„ç†)
      - name: Package Application
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p package/public
          mkdir -p package/.next/static

          # å¤åˆ¶ Standalone æ ¸å¿ƒæ–‡ä»¶
          # æ³¨æ„ï¼šLobeChat çš„ standalone ç›®å½•ç»“æ„å¯èƒ½è¾ƒæ·±ï¼Œé€šå¸¸åœ¨ .next/standalone/lobe-chat æˆ– .next/standalone
          # è¿™é‡Œä½¿ç”¨é€šé…ç¬¦ç¡®ä¿å¤åˆ¶å†…å®¹æ­£ç¡®
          cp -r .next/standalone/* package/

          # å¤åˆ¶é™æ€èµ„æº (è§£å†³æ ·å¼å’Œè„šæœ¬ä¸¢å¤±)
          cp -r .next/static package/.next/

          # å¤åˆ¶ Public (è§£å†³å›¾æ ‡å’Œå­—ä½“ä¸¢å¤±)
          cp -r public package/

          # âš ï¸ å…³é”®ï¼šåˆ é™¤ sharp
          # GitHub Action æ˜¯ x64 ç¯å¢ƒï¼Œç¼–è¯‘å‡ºçš„ sharp æ— æ³•åœ¨ Termux (ARM64) è¿è¡Œ
          # å¿…é¡»åˆ é™¤ï¼Œç„¶ååœ¨æ‰‹æœºä¸Šé‡æ–°å®‰è£…
          echo "ğŸš« åˆ é™¤ x64 æ¶æ„çš„ sharp..."
          rm -rf package/node_modules/sharp
          rm -rf package/node_modules/@img/sharp-libvips-linux-x64

          # å‹ç¼©
          echo "ğŸ—œï¸ æ­£åœ¨å‹ç¼©..."
          cd package
          tar -czvf ../lobe-termux.tar.gz .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼"

      # 5. ä¸Šä¼ äº§ç‰©
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobechat-build-fixed
          path: lobe-termux.tar.gz
          retention-days: 3
        env:
          NEXT_OUTPUT: standalone
          # ç»•è¿‡ T3 Env æˆ– Zod çš„æ ¡éªŒ
          SKIP_ENV_VALIDATION: true 
          # æä¾›å‡çš„å¿…é¡»å˜é‡ï¼Œé˜²æ­¢æ„å»ºå´©æºƒ
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/lobe"
          KEY_VAULTS_SECRET: "dummy_secret_for_build_process"
          NEXT_AUTH_SECRET: "dummy_secret_for_build_process"
          APP_URL: "http://localhost:3000"

      # 4. æ‰“åŒ…å¤„ç† (è§£å†³æ¶æ„ä¸å…¼å®¹é—®é¢˜)
      - name: Package Application
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          mkdir -p package/public
          mkdir -p package/.next/static

          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
          cp -r .next/standalone/* package/
          # å¤åˆ¶é™æ€èµ„æº (è§£å†³æ ·å¼ä¸¢å¤±)
          cp -r .next/static/* package/.next/static/
          # å¤åˆ¶ Public (è§£å†³å›¾æ ‡ä¸¢å¤±)
          cp -r public/* package/public/
          
          # âš ï¸ å…³é”®ï¼šåˆ é™¤ sharp (Linux x64)ï¼Œé˜²æ­¢åœ¨æ‰‹æœº (ARM64) ä¸ŠæŠ¥é”™
          # æˆ‘ä»¬ä¼šåœ¨ Termux è„šæœ¬é‡Œé‡æ–°å®‰è£…å®ƒ
          rm -rf package/node_modules/sharp

          # å‹ç¼©
          cd package
          tar -czvf ../lobe-termux.tar.gz .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼"

      # 5. ä¸Šä¼ äº§ç‰©
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobechat-build-fixed
          path: lobe-termux.tar.gz
          retention-days: 3
