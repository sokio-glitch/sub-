name: Build LobeChat for Termux (Fixed)

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. å…³é”®ä¿®å¤ï¼šæ˜¾å¼æŒ‡å®šæ‹‰å–å®˜æ–¹ä»“åº“ä»£ç 
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat  # å¼ºåˆ¶æ‹‰å–å®˜æ–¹æºç 
          ref: main                      # æ‹‰å–æœ€æ–°ä¸»åˆ†æ”¯
          fetch-depth: 1                 # æµ…å…‹éš†ï¼ŒåŠ å¿«é€Ÿåº¦

      # 2. ç¯å¢ƒå‡†å¤‡
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20               # LobeChat éœ€è¦ Node 20+

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9                     # æ›´æ–°åˆ° pnpm 9
          run_install: false

      - name: Install Dependencies
        run: pnpm install

      # 3. å…³é”®ä¿®å¤ï¼šæ„å»ºå¹¶ç»•è¿‡ä¸¥æ ¼çš„ç¯å¢ƒå˜é‡æ£€æŸ¥
      # LobeChat ç¼–è¯‘æ—¶é€šå¸¸éœ€è¦è¿æ¥ DBï¼Œæˆ‘ä»¬ç”¨å‡æ•°æ®æ¬ºéª—å®ƒ
      - name: Build Standalone
        run: pnpm build
        env:
          NEXT_OUTPUT: standalone
          # ç»•è¿‡ T3 Env æˆ– Zod çš„æ ¡éªŒ
          SKIP_ENV_VALIDATION: true 
          # æä¾›å‡çš„å¿…é¡»å˜é‡ï¼Œé˜²æ­¢æ„å»ºå´©æºƒ
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/lobe"
          KEY_VAULTS_SECRET: "dummy_secret_for_build_process"
          NEXT_AUTH_SECRET: "dummy_secret_for_build_process"
          APP_URL: "http://localhost:3000"

      # 4. æ‰“åŒ…å¤„ç† (è§£å†³æ¶æ„ä¸å…¼å®¹é—®é¢˜)
      - name: Package Application
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          mkdir -p package/public
          mkdir -p package/.next/static

          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
          cp -r .next/standalone/* package/
          # å¤åˆ¶é™æ€èµ„æº (è§£å†³æ ·å¼ä¸¢å¤±)
          cp -r .next/static/* package/.next/static/
          # å¤åˆ¶ Public (è§£å†³å›¾æ ‡ä¸¢å¤±)
          cp -r public/* package/public/
          
          # âš ï¸ å…³é”®ï¼šåˆ é™¤ sharp (Linux x64)ï¼Œé˜²æ­¢åœ¨æ‰‹æœº (ARM64) ä¸ŠæŠ¥é”™
          # æˆ‘ä»¬ä¼šåœ¨ Termux è„šæœ¬é‡Œé‡æ–°å®‰è£…å®ƒ
          rm -rf package/node_modules/sharp

          # å‹ç¼©
          cd package
          tar -czvf ../lobe-termux.tar.gz .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼"

      # 5. ä¸Šä¼ äº§ç‰©
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobechat-build-fixed
          path: lobe-termux.tar.gz
          retention-days: 3
