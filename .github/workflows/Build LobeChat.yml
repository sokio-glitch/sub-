name: Build LobeChat for Termux (No Release)

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Build Standalone
        run: pnpm build
        env:
          NEXT_OUTPUT: standalone

      # ğŸ“¦ æ‰“åŒ…ç¯èŠ‚ï¼šé‡ç»„æ–‡ä»¶ç»“æ„
      - name: Package Application
        run: |
          mkdir -p package/public
          mkdir -p package/.next/static
          
          # 1. å¤åˆ¶ Standalone æ ¸å¿ƒ
          cp -r .next/standalone/* package/
          # 2. å¤åˆ¶é™æ€èµ„æº (è§£å†³æ ·å¼ä¸¢å¤±)
          cp -r .next/static/* package/.next/static/
          # 3. å¤åˆ¶ Public (è§£å†³å›¾æ ‡ä¸¢å¤±)
          cp -r public/* package/public/
          
          # 4. åˆ é™¤ x64 æ¶æ„çš„ sharp (æ‰‹æœºæ˜¯ arm64ï¼Œéœ€è¦é‡è£…)
          rm -rf package/node_modules/sharp

          # 5. å‹ç¼©
          cd package
          tar -czvf ../lobe-termux.tar.gz .

      # ğŸ“¤ ä¸Šä¼ äº§ç‰© (åªåœ¨ Actions é¡µé¢å¯è§)
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobechat-build
          path: lobe-termux.tar.gz
          retention-days: 3 # è®¾ç½®ä¿ç•™3å¤©ï¼ŒèŠ‚çœç©ºé—´
