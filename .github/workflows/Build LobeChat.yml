name: Build LobeChat for Termux (Force Standalone)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false

      - name: Install Dependencies
        run: pnpm install

      # ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæ·»åŠ  DOCKER=true ç¯å¢ƒå˜é‡
      # è¿™ä¼šè§¦å‘ LobeChat çš„ next.config.mjs å¼€å¯ output: 'standalone'
      - name: Build Standalone (Bypass DB Checks)
        run: npx next build
        env:
          # å…³é”®å˜é‡ï¼šå‘Šè¯‰ LobeChat è¿™æ˜¯ä¸€ä¸ª Docker/Standalone æ„å»º
          DOCKER: true
          
          # æ˜¾å¼æŒ‡å®šï¼ˆåŒé‡ä¿é™©ï¼‰
          NEXT_OUTPUT: standalone
          
          # ç»•è¿‡æ•°æ®åº“æ£€æŸ¥
          SKIP_ENV_VALIDATION: true
          
          # å¿…é¡»çš„ Dummy å˜é‡
          AUTH_SECRET: "dummy_secret_for_build_process_32_chars_long"
          KEY_VAULTS_SECRET: "dummy_secret_for_build_process_32_chars_long"
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/lobe"
          APP_URL: "http://localhost:3000"
          
          # å¢åŠ å†…å­˜é™åˆ¶ï¼Œé˜²æ­¢æ„å»ºå´©
          NODE_OPTIONS: "--max-old-space-size=8192"

      - name: Package Application
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          # æ£€æŸ¥ standalone æ˜¯å¦å­˜åœ¨ (è°ƒè¯•ç”¨)
          ls -R .next/standalone || echo "âŒ Standalone ç›®å½•ä¾ç„¶ä¸å­˜åœ¨ï¼"
          
          mkdir -p package/public
          mkdir -p package/.next/static

          # 1. å¤åˆ¶ Standalone æ ¸å¿ƒ
          # ä½¿ç”¨ cp -r å¤åˆ¶ .next/standalone ä¸‹çš„æ‰€æœ‰å†…å®¹ï¼ˆåŒ…å« node_modules ç­‰ï¼‰
          cp -r .next/standalone/* package/

          # 2. å¤åˆ¶é™æ€èµ„æº (Next.js é»˜è®¤ä¸æ‰“å…¥ standaloneï¼Œå¿…é¡»æ‰‹åŠ¨è¡¥)
          # æ³¨æ„ï¼šæœ‰æ—¶å€™ .next/static å·²ç»åœ¨ standalone/.next/static é‡Œäº†ï¼Œä½†ä¸ºäº†ä¿é™©è¦†ç›–ä¸€æ¬¡
          cp -r .next/static package/.next/
          cp -r public package/

          # 3. ä¿®å¤ Termux å…¼å®¹æ€§
          echo "ğŸš« åˆ é™¤ x64 æ¶æ„çš„ sharp..."
          rm -rf package/node_modules/sharp
          rm -rf package/node_modules/@img/sharp-libvips-linux-x64

          # 4. å‹ç¼©
          echo "ğŸ—œï¸ æ­£åœ¨å‹ç¼©..."
          cd package
          tar -czvf ../lobe-termux.tar.gz .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobechat-termux-final-v3
          path: lobe-termux.tar.gz
          retention-days: 3
          
          # å¿…é¡»å˜é‡ (éª—è¿‡ Next.js çš„å¯åŠ¨æ£€æŸ¥)
          AUTH_SECRET: "dummy_secret_for_build_process_32_chars_long"
          KEY_VAULTS_SECRET: "dummy_secret_for_build_process_32_chars_long"
          
          # å¿…é¡»å˜é‡ (é˜²æ­¢æ„å»ºæ—¶è¿æ¥æ•°æ®åº“æŠ¥é”™)
          # ä½¿ç”¨ postgres åè®®ï¼Œä½†æŒ‡å‘æ— æ•ˆåœ°å€ä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸ºæˆ‘ä»¬è·³è¿‡äº† migrate
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/lobe"
          APP_URL: "http://localhost:3000"
          
          # æ ¸å¿ƒï¼šè·³è¿‡ç¯å¢ƒå˜é‡æ ¼å¼æ ¡éªŒ
          SKIP_ENV_VALIDATION: true

      - name: Package Application
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          mkdir -p package/public
          mkdir -p package/.next/static

          # 1. å¤åˆ¶ Standalone æ ¸å¿ƒ
          # è¿™ä¸€æ­¥å¯èƒ½ä¼šæœ‰æ·±å±‚ç›®å½•ç»“æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨ rsync æˆ– cp é€’å½’åˆå¹¶
          # é€šå¸¸ç»“æ„æ˜¯ .next/standalone/node_modules å’Œ .next/standalone/package.json
          cp -r .next/standalone/* package/

          # 2. å¤åˆ¶é™æ€èµ„æº (Next.js é»˜è®¤ä¸æŠŠè¿™äº›æ‰“è¿› standalone)
          cp -r .next/static package/.next/
          cp -r public package/

          # 3. ä¿®å¤ Termux å…¼å®¹æ€§ (åˆ é™¤ x64 sharp)
          echo "ğŸš« åˆ é™¤ x64 æ¶æ„çš„ sharp..."
          rm -rf package/node_modules/sharp
          rm -rf package/node_modules/@img/sharp-libvips-linux-x64

          # 4. å‹ç¼©
          echo "ğŸ—œï¸ æ­£åœ¨å‹ç¼©..."
          cd package
          tar -czvf ../lobe-termux.tar.gz .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobechat-termux-final
          path: lobe-termux.tar.gz
          retention-days: 3
