name: Build LobeChat for Termux (V4 - Fix Hidden Files)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false

      - name: Install Dependencies
        run: pnpm install

      - name: Build Standalone
        run: npx next build
        env:
          DOCKER: true
          NEXT_OUTPUT: standalone
          SKIP_ENV_VALIDATION: true
          AUTH_SECRET: "dummy_secret_for_build_process_32_chars_long"
          KEY_VAULTS_SECRET: "dummy_secret_for_build_process_32_chars_long"
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/lobe"
          APP_URL: "http://localhost:3000"
          NODE_OPTIONS: "--max-old-space-size=8192"

      - name: Package Application
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          mkdir -p package/public
          mkdir -p package/.next/static

          # --- ğŸ”´ å…³é”®ä¿®å¤ V4 START ---
          # ä¹‹å‰çš„ cp * æ¼æ‰äº† .next æ–‡ä»¶å¤¹
          # æˆ‘ä»¬ç°åœ¨æ˜¾å¼å¤åˆ¶æ‰€æœ‰å†…å®¹
          
          # 1. å¤åˆ¶ standalone ä¸‹çš„æ ¸å¿ƒ .next æ–‡ä»¶å¤¹ (åŒ…å« BUILD_ID)
          cp -r .next/standalone/.next package/
          
          # 2. å¤åˆ¶ server.js å’Œå…¶ä»–æ–‡ä»¶
          cp .next/standalone/server.js package/
          cp .next/standalone/package.json package/ || true
          
          # 3. å¤åˆ¶ä¾èµ– (node_modules)
          cp -r .next/standalone/node_modules package/
          # --- ğŸ”´ å…³é”®ä¿®å¤ V4 END ---

          # 4. è¡¥å…¨é™æ€èµ„æº (Next.js é»˜è®¤ä¸æ‰“åŒ… static åˆ° standalone)
          # æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ -n (no-clobber) é˜²æ­¢è¦†ç›–å·²æœ‰çš„æ–‡ä»¶ï¼Œåªè¡¥å……ç¼ºå¤±çš„
          cp -rn .next/static/* package/.next/static/
          
          # 5. å¤åˆ¶ Public ç›®å½•
          cp -r public package/

          # 6. åˆ é™¤ x64 sharp (Termux éœ€è‡ªè¡Œå®‰è£…)
          echo "ğŸš« åˆ é™¤ x64 æ¶æ„çš„ sharp..."
          rm -rf package/node_modules/sharp
          rm -rf package/node_modules/@img/sharp-libvips-linux-x64

          # 7. å‹ç¼©
          echo "ğŸ—œï¸ æ­£åœ¨å‹ç¼©..."
          cd package
          tar -czvf ../lobe-termux.tar.gz .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobechat-termux-v4
          path: lobe-termux.tar.gz
          retention-days: 3
