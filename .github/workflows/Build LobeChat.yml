name: Build LobeChat for Termux (Bypass DB)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false

      - name: Install Dependencies
        run: pnpm install

      # ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šç›´æ¥ä½¿ç”¨ Next.js æ„å»ºï¼Œç»•è¿‡ pnpm build ä¸­çš„ db:migrate
      - name: Build Standalone (Bypass DB)
        run: npx next build
        env:
          # å‘Šè¯‰ Next.js ç”Ÿæˆç‹¬ç«‹è¿è¡ŒåŒ…
          NEXT_OUTPUT: standalone
          
          # å¿…é¡»å˜é‡ (éª—è¿‡ Next.js çš„å¯åŠ¨æ£€æŸ¥)
          AUTH_SECRET: "dummy_secret_for_build_process_32_chars_long"
          KEY_VAULTS_SECRET: "dummy_secret_for_build_process_32_chars_long"
          
          # å¿…é¡»å˜é‡ (é˜²æ­¢æ„å»ºæ—¶è¿æ¥æ•°æ®åº“æŠ¥é”™)
          # ä½¿ç”¨ postgres åè®®ï¼Œä½†æŒ‡å‘æ— æ•ˆåœ°å€ä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸ºæˆ‘ä»¬è·³è¿‡äº† migrate
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/lobe"
          APP_URL: "http://localhost:3000"
          
          # æ ¸å¿ƒï¼šè·³è¿‡ç¯å¢ƒå˜é‡æ ¼å¼æ ¡éªŒ
          SKIP_ENV_VALIDATION: true

      - name: Package Application
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          mkdir -p package/public
          mkdir -p package/.next/static

          # 1. å¤åˆ¶ Standalone æ ¸å¿ƒ
          # è¿™ä¸€æ­¥å¯èƒ½ä¼šæœ‰æ·±å±‚ç›®å½•ç»“æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨ rsync æˆ– cp é€’å½’åˆå¹¶
          # é€šå¸¸ç»“æ„æ˜¯ .next/standalone/node_modules å’Œ .next/standalone/package.json
          cp -r .next/standalone/* package/

          # 2. å¤åˆ¶é™æ€èµ„æº (Next.js é»˜è®¤ä¸æŠŠè¿™äº›æ‰“è¿› standalone)
          cp -r .next/static package/.next/
          cp -r public package/

          # 3. ä¿®å¤ Termux å…¼å®¹æ€§ (åˆ é™¤ x64 sharp)
          echo "ğŸš« åˆ é™¤ x64 æ¶æ„çš„ sharp..."
          rm -rf package/node_modules/sharp
          rm -rf package/node_modules/@img/sharp-libvips-linux-x64

          # 4. å‹ç¼©
          echo "ğŸ—œï¸ æ­£åœ¨å‹ç¼©..."
          cd package
          tar -czvf ../lobe-termux.tar.gz .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobechat-termux-final
          path: lobe-termux.tar.gz
          retention-days: 3
