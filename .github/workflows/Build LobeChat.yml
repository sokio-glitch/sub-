name: Build LobeChat for Termux (Bun + DB Fix)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # 1. æ–°å¢ï¼šå¯åŠ¨ä¸€ä¸ªä¸´æ—¶çš„ Postgres æœåŠ¡
    # LobeChat æ„å»ºè„šæœ¬éœ€è¦è¿æ¥æ•°æ®åº“ç”Ÿæˆ Schema æˆ–è¿ç§»ï¼Œæˆ‘ä»¬ç»™å®ƒä¸€ä¸ªç©ºçš„ DB ç©
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: lobe
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 1

      # 2. æ–°å¢ï¼šå®‰è£… Bun ç¯å¢ƒ
      # è§£å†³ "sh: 1: bun: not found" é”™è¯¯
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false

      - name: Install Dependencies
        run: pnpm install

      - name: Build Standalone
        run: pnpm build
        env:
          NEXT_OUTPUT: standalone
          SKIP_ENV_VALIDATION: true
          
          # è®¤è¯å¯†é’¥ (å¿…é¡»æä¾›)
          AUTH_SECRET: "dummy_secret_for_build_process_32_chars_long"
          KEY_VAULTS_SECRET: "dummy_secret_for_build_process_32_chars_long"
          
          # æ•°æ®åº“è¿æ¥ (æŒ‡å‘ä¸Šé¢å®šä¹‰çš„ä¸´æ—¶æœåŠ¡)
          # æ³¨æ„ï¼šè¿™é‡Œè¿æ¥çš„æ˜¯ localhost:5432 (Github Action çš„ Service ä¼šæ˜ å°„åˆ°è¿™é‡Œ)
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/lobe"
          
          APP_URL: "http://localhost:3000"

      - name: Package Application
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          mkdir -p package/public
          mkdir -p package/.next/static

          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
          cp -r .next/standalone/* package/
          cp -r .next/static package/.next/
          cp -r public package/

          # âš ï¸ åˆ é™¤ sharp (Termux ARM64 éœ€è‡ªè¡Œå®‰è£…)
          echo "ğŸš« åˆ é™¤ x64 æ¶æ„çš„ sharp..."
          rm -rf package/node_modules/sharp
          rm -rf package/node_modules/@img/sharp-libvips-linux-x64

          # å‹ç¼©
          echo "ğŸ—œï¸ æ­£åœ¨å‹ç¼©..."
          cd package
          tar -czvf ../lobe-termux.tar.gz .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobechat-build-fixed-bun
          path: lobe-termux.tar.gz
          retention-days: 3
          SKIP_ENV_VALIDATION: true
          
          # --- æ ¸å¿ƒä¿®å¤ START ---
          # æŠ¥é”™æ˜ç¡®æŒ‡å‡ºå¿…é¡»å­˜åœ¨ AUTH_SECRET
          AUTH_SECRET: "dummy_secret_for_build_process_32_chars_long"
          # ä¸ºäº†ä¿é™©èµ·è§ï¼Œä¿ç•™ KEY_VAULTS_SECRET
          KEY_VAULTS_SECRET: "dummy_secret_for_build_process_32_chars_long"
          # --- æ ¸å¿ƒä¿®å¤ END ---

          # æä¾›æ•°æ®åº“ URL æ ¼å¼æ¬ºéª—éªŒè¯
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/lobe"
          APP_URL: "http://localhost:3000"

      - name: Package Application
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          mkdir -p package/public
          mkdir -p package/.next/static

          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
          # æ³¨æ„ï¼šæœ‰æ—¶å€™ standalone ç»“æ„ä¼šåŒ…å« .next/standalone/lobe-chatï¼Œè¿™é‡Œç›´æ¥å¤åˆ¶å†…å®¹
          cp -r .next/standalone/* package/

          # å¤åˆ¶é™æ€èµ„æº
          cp -r .next/static package/.next/
          
          # å¤åˆ¶ Public
          cp -r public package/

          # âš ï¸ åˆ é™¤ sharp (Termux éœ€è¦è‡ªè¡Œå®‰è£…)
          echo "ğŸš« åˆ é™¤ x64 æ¶æ„çš„ sharp..."
          rm -rf package/node_modules/sharp
          rm -rf package/node_modules/@img/sharp-libvips-linux-x64

          # å‹ç¼©
          echo "ğŸ—œï¸ æ­£åœ¨å‹ç¼©..."
          cd package
          tar -czvf ../lobe-termux.tar.gz .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobechat-build-fixed-v2
          path: lobe-termux.tar.gz
          retention-days: 3
          NEXT_OUTPUT: standalone
          # ä¾ç„¶ä¿ç•™è·³è¿‡éªŒè¯ï¼Œé˜²æ­¢æ ¡éªŒæ•°æ®åº“è¿æ¥
          SKIP_ENV_VALIDATION: true
          
          # --- ä¿®å¤éƒ¨åˆ† START ---
          # âŒ å¿…é¡»åˆ é™¤: NEXT_AUTH_SECRET (ä¼šå¯¼è‡´æ„å»ºå¤±è´¥)
          # âœ… æ–°å¢: LobeChat v2 ä½¿ç”¨ LOBE_AUTH_SECRET ä½œä¸ºä¸»å¯†é’¥
          LOBE_AUTH_SECRET: "dummy_secret_for_build_process_32_chars_long"
          # --- ä¿®å¤éƒ¨åˆ† END ---

          # æä¾›å…¶ä»–å¿…è¦çš„å‡å˜é‡
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/lobe"
          KEY_VAULTS_SECRET: "dummy_secret_for_build_process"
          APP_URL: "http://localhost:3000"

      # 4. æ‰“åŒ…å¤„ç† (é’ˆå¯¹ Termux çš„ç‰¹æ®Šå¤„ç†)
      - name: Package Application
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p package/public
          mkdir -p package/.next/static

          # å¤åˆ¶ Standalone æ ¸å¿ƒæ–‡ä»¶
          # æ³¨æ„ï¼šLobeChat çš„ standalone ç›®å½•ç»“æ„å¯èƒ½è¾ƒæ·±ï¼Œé€šå¸¸åœ¨ .next/standalone/lobe-chat æˆ– .next/standalone
          # è¿™é‡Œä½¿ç”¨é€šé…ç¬¦ç¡®ä¿å¤åˆ¶å†…å®¹æ­£ç¡®
          cp -r .next/standalone/* package/

          # å¤åˆ¶é™æ€èµ„æº (è§£å†³æ ·å¼å’Œè„šæœ¬ä¸¢å¤±)
          cp -r .next/static package/.next/

          # å¤åˆ¶ Public (è§£å†³å›¾æ ‡å’Œå­—ä½“ä¸¢å¤±)
          cp -r public package/

          # âš ï¸ å…³é”®ï¼šåˆ é™¤ sharp
          # GitHub Action æ˜¯ x64 ç¯å¢ƒï¼Œç¼–è¯‘å‡ºçš„ sharp æ— æ³•åœ¨ Termux (ARM64) è¿è¡Œ
          # å¿…é¡»åˆ é™¤ï¼Œç„¶ååœ¨æ‰‹æœºä¸Šé‡æ–°å®‰è£…
          echo "ğŸš« åˆ é™¤ x64 æ¶æ„çš„ sharp..."
          rm -rf package/node_modules/sharp
          rm -rf package/node_modules/@img/sharp-libvips-linux-x64

          # å‹ç¼©
          echo "ğŸ—œï¸ æ­£åœ¨å‹ç¼©..."
          cd package
          tar -czvf ../lobe-termux.tar.gz .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼"

      # 5. ä¸Šä¼ äº§ç‰©
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobechat-build-fixed
          path: lobe-termux.tar.gz
          retention-days: 3
        env:
          NEXT_OUTPUT: standalone
          # ç»•è¿‡ T3 Env æˆ– Zod çš„æ ¡éªŒ
          SKIP_ENV_VALIDATION: true 
          # æä¾›å‡çš„å¿…é¡»å˜é‡ï¼Œé˜²æ­¢æ„å»ºå´©æºƒ
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/lobe"
          KEY_VAULTS_SECRET: "dummy_secret_for_build_process"
          NEXT_AUTH_SECRET: "dummy_secret_for_build_process"
          APP_URL: "http://localhost:3000"

      # 4. æ‰“åŒ…å¤„ç† (è§£å†³æ¶æ„ä¸å…¼å®¹é—®é¢˜)
      - name: Package Application
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          mkdir -p package/public
          mkdir -p package/.next/static

          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
          cp -r .next/standalone/* package/
          # å¤åˆ¶é™æ€èµ„æº (è§£å†³æ ·å¼ä¸¢å¤±)
          cp -r .next/static/* package/.next/static/
          # å¤åˆ¶ Public (è§£å†³å›¾æ ‡ä¸¢å¤±)
          cp -r public/* package/public/
          
          # âš ï¸ å…³é”®ï¼šåˆ é™¤ sharp (Linux x64)ï¼Œé˜²æ­¢åœ¨æ‰‹æœº (ARM64) ä¸ŠæŠ¥é”™
          # æˆ‘ä»¬ä¼šåœ¨ Termux è„šæœ¬é‡Œé‡æ–°å®‰è£…å®ƒ
          rm -rf package/node_modules/sharp

          # å‹ç¼©
          cd package
          tar -czvf ../lobe-termux.tar.gz .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼"

      # 5. ä¸Šä¼ äº§ç‰©
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobechat-build-fixed
          path: lobe-termux.tar.gz
          retention-days: 3
