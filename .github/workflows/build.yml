name: Remote Build Skills for Termux

on:
  workflow_dispatch:

jobs:
  cross-compile:
    runs-on: ubuntu-latest
    steps:
      - name: Manual Clone Source Code
        run: git clone --depth 1 https://github.com/labiium/skills.git .

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          # å®‰è£… perl (ç¼–è¯‘ OpenSSL æºç å¿…éœ€) å’Œ cargo-ndk
          sudo apt-get install -y cmake ninja-build perl
          cargo install cargo-ndk

      - name: Patch Cargo.toml for OpenSSL
        run: |
          # ğŸŒŸ å…³é”®æ­¥éª¤ï¼šå¼ºåˆ¶å‘é¡¹ç›®æ·»åŠ  openssl ä¾èµ–å¹¶å¼€å¯ vendored ç‰¹æ€§
          # è¿™ä¼šè¿«ä½¿ openssl-sys ä¸‹è½½æºç å¹¶ä½¿ç”¨ NDK ç¼–è¯‘ï¼Œè€Œä¸æ˜¯å»ç³»ç»Ÿé‡Œä¹±æ‰¾
          cargo add openssl --features vendored

      - name: Build with Cargo NDK
        run: |
          # ç»Ÿä¸€ NDK è·¯å¾„
          export ANDROID_NDK_HOME=$ANDROID_NDK_LATEST_HOME
          export ANDROID_NDK_ROOT=$ANDROID_NDK_LATEST_HOME
          
          # å¼€å§‹äº¤å‰ç¼–è¯‘
          # æˆ‘ä»¬ä¸å†éœ€è¦è®¾ç½® OPENSSL_DIRï¼Œå› ä¸º vendored æ¨¡å¼ä¼šè‡ªåŠ¨å¤„ç†ä¸€åˆ‡
          cargo ndk -t aarch64-linux-android --platform 21 build --release

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: skills-termux-bin
          path: target/aarch64-linux-android/release/skills
          # æ˜ç¡®è®¾ç½® OpenSSL ç¯å¢ƒå˜é‡
          OPENSSL_DIR: ""

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: skills-termux-bin
          path: target/aarch64-linux-android/release/skills
