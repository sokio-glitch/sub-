name: Remote Build Skills for Termux

on:
  workflow_dispatch:

jobs:
  cross-compile:
    runs-on: ubuntu-latest
    steps:
      - name: Manual Clone Source Code
        run: git clone --depth 1 https://github.com/labiium/skills.git .

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          # 安装 cmake 和 ninja，很多底层 Rust 库（如 aws-lc-sys）在 Android 交叉编译时需要它们
          sudo apt-get install -y cmake ninja-build
          cargo install cargo-ndk

      - name: Build with Cargo NDK
        run: |
          # 1. 明确指向 GitHub Actions 预装的 NDK 路径
          export ANDROID_NDK_HOME=$ANDROID_NDK_LATEST_HOME
          
          # 2. 这里的参数非常关键：
          # -t aarch64-linux-android: 目标架构
          # -p 21: Termux 推荐的 API Level
          # --: 后接标准的 cargo 参数
          cargo ndk -t aarch64-linux-android -p 21 build --release
        env:
          # 有些库在编译 C 代码时需要明确指定编译器
          CC_aarch64_linux_android: aarch64-linux-android21-clang
          AR_aarch64_linux_android: aarch64-linux-android-ar

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: skills-termux-bin
          path: target/aarch64-linux-android/release/skills

      # 5. 上传二进制产物
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: skills-termux-bin
          path: target/aarch64-linux-android/release/skills
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: skills-termux-bin
          path: target/aarch64-linux-android/release/skills
