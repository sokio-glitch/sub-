name: Remote Build Skills for Termux

on:
  workflow_dispatch: # 允许手动点击按钮触发

jobs:
  cross-compile:
    runs-on: ubuntu-latest
    steps:
      # 1. 匿名克隆源码到当前目录
      - name: Manual Clone Source Code
        run: git clone --depth 1 https://github.com/labiium/skills.git .

      # 2. 安装 Rust 环境及 Android 目标平台
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      # 3. 安装底层编译依赖
      # cmake 和 ninja 是编译加密库（如 aws-lc-sys）所必须的
      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build
          cargo install cargo-ndk

      # 4. 执行交叉编译
      - name: Build with Cargo NDK
        run: |
          # 统一 NDK 环境变量，防止 cargo-ndk 报版本不匹配的 Panic
          export ANDROID_NDK_HOME=$ANDROID_NDK_LATEST_HOME
          export ANDROID_NDK_ROOT=$ANDROID_NDK_LATEST_HOME
          
          # 核心修正：使用 --platform 21 而不是 -p 21
          # 这样会正确识别为 Android API Level，而不会被误认为是一个名为 "21" 的项目包
          cargo ndk -t aarch64-linux-android --platform 21 build --release
          
      # 5. 上传生成的二进制文件
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: skills-termux-bin
          # 产物路径在 target 的对应架构目录下
          path: target/aarch64-linux-android/release/skills
          CC_aarch64_linux_android: aarch64-linux-android21-clang
          AR_aarch64_linux_android: aarch64-linux-android-ar

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: skills-termux-bin
          path: target/aarch64-linux-android/release/skills

      # 5. 上传二进制产物
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: skills-termux-bin
          path: target/aarch64-linux-android/release/skills
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: skills-termux-bin
          path: target/aarch64-linux-android/release/skills
