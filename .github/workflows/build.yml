name: Remote Build Skills for Termux

on:
  workflow_dispatch:

jobs:
  cross-compile:
    runs-on: ubuntu-latest
    steps:
      - name: Manual Clone Source Code
        run: git clone --depth 1 https://github.com/labiium/skills.git .

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build
          cargo install cargo-ndk

      - name: Build with Cargo NDK
        run: |
          # 统一 NDK 路径
          export ANDROID_NDK_HOME=$ANDROID_NDK_LATEST_HOME
          export ANDROID_NDK_ROOT=$ANDROID_NDK_LATEST_HOME
          
          # 强制 OpenSSL 源码编译 (解决 openssl-sys 错误)
          export OPENSSL_STATIC=1
          export OPENSSL_NO_VENDOR=0
          
          # 执行交叉编译
          cargo ndk -t aarch64-linux-android --platform 21 build --release
        env:
          # 明确设置 OpenSSL 环境变量
          OPENSSL_DIR: ""

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: skills-termux-bin
          path: target/aarch64-linux-android/release/skills
