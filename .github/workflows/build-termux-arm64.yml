name: Build LobeChat for Termux (ARM64 Fixed)

on:
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 1

      # ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šåˆ›å»º 10GB çš„ Swap ç©ºé—´ (è™šæ‹Ÿå†…å­˜)
      # è¿™èƒ½é˜²æ­¢ QEMU æ¨¡æ‹Ÿæ„å»ºæ—¶å†…å­˜ä¸è¶³å´©æºƒ
      - name: Enable Swap Space
        run: |
          sudo fallocate -l 10G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo swapon --show
          echo "âœ… Swap memory enabled!"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šä¼ é€’æ„å»ºå‚æ•°ï¼Œé™åˆ¶å†…å­˜ï¼Œè·³è¿‡æ£€æŸ¥
      - name: Build and Export
        run: |
          echo "ğŸ¢ å¼€å§‹æ„å»º ARM64 ç‰ˆæœ¬ (é¢„è®¡è€—æ—¶ 20-40 åˆ†é’Ÿ)..."
          
          mkdir -p ./output
          
          # å¢åŠ  --build-arg é™åˆ¶å†…å­˜å’Œè·³è¿‡éªŒè¯
          docker buildx build \
             --platform linux/arm64 \
             --output type=tar,dest=./lobe-arm64.tar \
             --build-arg NODE_OPTIONS="--max-old-space-size=4096" \
             --build-arg SKIP_ENV_VALIDATION=true \
             --build-arg NEXT_PUBLIC_ANALYTICS_GOOGLE="" \
             --build-arg NEXT_PUBLIC_ANALYTICS_VERCEL="" \
             .

      - name: Repackage
        run: |
          echo "ğŸ“‚ è§£åŒ…ä¸­..."
          mkdir -p temp_extract
          tar -xf lobe-arm64.tar -C temp_extract
          
          mkdir -p final_package
          
          echo "ğŸ“‚ æå–æ ¸å¿ƒæ–‡ä»¶..."
          # æ³¨æ„ï¼šæœ‰æ—¶å€™ Docker å¯¼å‡ºçš„ç»“æ„ä¼šæœ‰å˜åŒ–ï¼Œè¿™é‡Œå°è¯•åŒ¹é… app ç›®å½•
          # å¦‚æœ Dockerfile WORKDIR æ˜¯ /appï¼Œåˆ™å†…å®¹åœ¨ /app ä¸‹
          if [ -d "temp_extract/app" ]; then
            cp -r temp_extract/app/* final_package/
          else
            # å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœç»“æ„ä¸åŒï¼Œå°è¯•ç›´æ¥å¤åˆ¶æ‰€æœ‰
            echo "âš ï¸ æ ‡å‡†è·¯å¾„æœªæ‰¾åˆ°ï¼Œå°è¯•å…¨é‡æœç´¢..."
            cp -r temp_extract/* final_package/ || true
          fi
          
          # æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶ (å‡å°ä½“ç§¯)
          rm -rf final_package/src || true
          rm -rf final_package/.git || true
          
          echo "ğŸ§ æ£€æŸ¥ sharp æ¶æ„..."
          # æŸ¥æ‰¾ sharp.node æ–‡ä»¶ä»¥éªŒè¯æ¶æ„
          find final_package -name "sharp-linux-arm64.node" || echo "âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ° ARM64 sharpï¼Œè¯·æ£€æŸ¥æ—¥å¿—"

          echo "ğŸ“¦ æœ€ç»ˆå‹ç¼©..."
          cd final_package
          tar -czvf ../lobe-chat-termux-arm64.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobe-chat-termux-arm64
          path: lobe-chat-termux-arm64.tar.gz
          retention-days: 3
          docker buildx build \
             --platform linux/arm64 \
             --output type=tar,dest=./lobe-arm64.tar \
             .

      # 4. è§£åŒ…å¹¶é‡æ–°æ‰“åŒ… (ä¸ºäº†å‡å°ä½“ç§¯å’Œæ¸…ç†ç»“æ„)
      - name: Repackage
        run: |
          mkdir -p temp_extract
          tar -xf lobe-arm64.tar -C temp_extract
          
          mkdir -p final_package
          
          echo "ğŸ“‚ æå–æ ¸å¿ƒæ–‡ä»¶..."
          # Docker å¯¼å‡ºçš„ tar åŒ…å«æ•´ä¸ª Linux ç³»ç»Ÿç»“æ„
          # æˆ‘ä»¬åªéœ€è¦ /app ç›®å½•ä¸‹çš„å†…å®¹
          cp -r temp_extract/app/* final_package/
          
          # éªŒè¯ä¸€ä¸‹æ¶æ„ (ç¡®ä¿æ˜¯ ARM64)
          echo "ğŸ§ æ£€æŸ¥ sharp æ¶æ„..."
          file final_package/node_modules/sharp/build/Release/sharp-linux-arm64.node || echo "âš ï¸ æ²¡æ‰¾åˆ° sharp äºŒè¿›åˆ¶ï¼Œå¯èƒ½è·¯å¾„ä¸åŒ"

          echo "ğŸ“¦ æœ€ç»ˆå‹ç¼©..."
          cd final_package
          tar -czvf ../lobe-chat-termux-arm64.tar.gz .

      # 5. ä¸Šä¼ 
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobe-chat-termux-arm64
          path: lobe-chat-termux-arm64.tar.gz
          retention-days: 3
