name: Build LobeChat for Termux (ARM64 Swap Fix)

on:
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 1

      # ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨è‡ªå®šä¹‰æ–‡ä»¶ååˆ›å»º Swap
      # é¿å…å’Œç³»ç»Ÿé»˜è®¤çš„ /swapfile å†²çª
      - name: Enable Swap Space
        run: |
          echo "Checking existing swap..."
          sudo swapon --show
          
          echo "Creating custom swap file..."
          # ä½¿ç”¨ /swapfile_build é¿å… "Text file busy" é”™è¯¯
          sudo fallocate -l 10G /swapfile_build
          sudo chmod 600 /swapfile_build
          sudo mkswap /swapfile_build
          sudo swapon /swapfile_build
          
          echo "âœ… New swap enabled:"
          sudo swapon --show

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ğŸ”¥ æ„å»ºæ­¥éª¤ï¼šå¢åŠ å†…å­˜é™åˆ¶å‚æ•°
      - name: Build and Export
        run: |
          echo "ğŸ¢ å¼€å§‹æ„å»º ARM64 ç‰ˆæœ¬ (é¢„è®¡è€—æ—¶ 30-50 åˆ†é’Ÿ)..."
          
          mkdir -p ./output
          
          # ä½¿ç”¨ buildx æ„å»º
          # --load: åŠ è½½åˆ°æœ¬åœ° docker daemon (ä¸é€‚ç”¨å¤šæ¶æ„)
          # --output type=tar: ç›´æ¥å¯¼å‡ºæ–‡ä»¶ç³»ç»Ÿ
          docker buildx build \
             --platform linux/arm64 \
             --output type=tar,dest=./lobe-arm64.tar \
             --build-arg NODE_OPTIONS="--max-old-space-size=4096" \
             --build-arg SKIP_ENV_VALIDATION=true \
             .

      - name: Repackage
        run: |
          echo "ğŸ“‚ è§£åŒ…ä¸­..."
          mkdir -p temp_extract
          tar -xf lobe-arm64.tar -C temp_extract
          
          mkdir -p final_package
          
          echo "ğŸ“‚ æå–æ ¸å¿ƒæ–‡ä»¶..."
          # å°è¯•ä»å¸¸è§çš„ Docker ç›®å½•æå–
          if [ -d "temp_extract/app" ]; then
            cp -r temp_extract/app/* final_package/
          else
            echo "âš ï¸ æ ‡å‡†è·¯å¾„ /app æœªæ‰¾åˆ°ï¼Œå°è¯•æå–æ ¹ç›®å½•..."
            # æœ‰æ—¶å€™ Docker export å‡ºæ¥ç›´æ¥å°±æ˜¯æ ¹ç›®å½•
            cp -r temp_extract/* final_package/ 2>/dev/null || true
          fi
          
          # æ¸…ç†åƒåœ¾æ–‡ä»¶ (å‡å°ä½“ç§¯)
          rm -rf final_package/src || true
          rm -rf final_package/.git || true
          rm -rf final_package/tmp || true
          
          # éªŒè¯æ¶æ„
          echo "ğŸ§ æ£€æŸ¥ sharp æ¶æ„..."
          find final_package -name "sharp-linux-arm64.node" -print -quit | grep -q . && echo "âœ… æˆåŠŸæ£€æµ‹åˆ° ARM64 Sharp" || echo "âš ï¸ æœªæ£€æµ‹åˆ° ARM64 Sharp"

          echo "ğŸ“¦ æœ€ç»ˆå‹ç¼©..."
          cd final_package
          tar -czvf ../lobe-chat-termux-arm64.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobe-chat-termux-arm64
          path: lobe-chat-termux-arm64.tar.gz
          retention-days: 3
          echo "ğŸ¢ å¼€å§‹æ„å»º ARM64 ç‰ˆæœ¬ (é¢„è®¡è€—æ—¶ 20-40 åˆ†é’Ÿ)..."
          
          mkdir -p ./output
          
          # å¢åŠ  --build-arg é™åˆ¶å†…å­˜å’Œè·³è¿‡éªŒè¯
          docker buildx build \
             --platform linux/arm64 \
             --output type=tar,dest=./lobe-arm64.tar \
             --build-arg NODE_OPTIONS="--max-old-space-size=4096" \
             --build-arg SKIP_ENV_VALIDATION=true \
             --build-arg NEXT_PUBLIC_ANALYTICS_GOOGLE="" \
             --build-arg NEXT_PUBLIC_ANALYTICS_VERCEL="" \
             .

      - name: Repackage
        run: |
          echo "ğŸ“‚ è§£åŒ…ä¸­..."
          mkdir -p temp_extract
          tar -xf lobe-arm64.tar -C temp_extract
          
          mkdir -p final_package
          
          echo "ğŸ“‚ æå–æ ¸å¿ƒæ–‡ä»¶..."
          # æ³¨æ„ï¼šæœ‰æ—¶å€™ Docker å¯¼å‡ºçš„ç»“æ„ä¼šæœ‰å˜åŒ–ï¼Œè¿™é‡Œå°è¯•åŒ¹é… app ç›®å½•
          # å¦‚æœ Dockerfile WORKDIR æ˜¯ /appï¼Œåˆ™å†…å®¹åœ¨ /app ä¸‹
          if [ -d "temp_extract/app" ]; then
            cp -r temp_extract/app/* final_package/
          else
            # å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœç»“æ„ä¸åŒï¼Œå°è¯•ç›´æ¥å¤åˆ¶æ‰€æœ‰
            echo "âš ï¸ æ ‡å‡†è·¯å¾„æœªæ‰¾åˆ°ï¼Œå°è¯•å…¨é‡æœç´¢..."
            cp -r temp_extract/* final_package/ || true
          fi
          
          # æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶ (å‡å°ä½“ç§¯)
          rm -rf final_package/src || true
          rm -rf final_package/.git || true
          
          echo "ğŸ§ æ£€æŸ¥ sharp æ¶æ„..."
          # æŸ¥æ‰¾ sharp.node æ–‡ä»¶ä»¥éªŒè¯æ¶æ„
          find final_package -name "sharp-linux-arm64.node" || echo "âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ° ARM64 sharpï¼Œè¯·æ£€æŸ¥æ—¥å¿—"

          echo "ğŸ“¦ æœ€ç»ˆå‹ç¼©..."
          cd final_package
          tar -czvf ../lobe-chat-termux-arm64.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobe-chat-termux-arm64
          path: lobe-chat-termux-arm64.tar.gz
          retention-days: 3
