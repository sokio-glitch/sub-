name: Build LobeChat for Termux (ARM64 Native)

on:
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: main
          fetch-depth: 1

      # 1. å¯ç”¨ QEMU (è®© GitHub çš„ x86 æœºå™¨èƒ½æ„å»º ARM64)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2. å¯ç”¨ Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. æ„å»ºå¹¶å¯¼å‡ºæ–‡ä»¶
      # æ³¨æ„ï¼šè¿™æ­¥ä¼šæ¯”è¾ƒæ…¢ (20-40åˆ†é’Ÿ)ï¼Œå› ä¸ºæ˜¯åœ¨æ¨¡æ‹Ÿ ARM CPU
      - name: Build and Export
        run: |
          echo "ğŸ¢ å¼€å§‹æ„å»º ARM64 ç‰ˆæœ¬ (è¯·è€å¿ƒç­‰å¾…)..."
          
          # åˆ›å»ºä¸€ä¸ªè¾“å‡ºç›®å½•
          mkdir -p ./output
          
          # ä½¿ç”¨ buildx æ„å»ºï¼Œå¹¶ç›´æ¥å°†æ„å»ºç»“æœå¯¼å‡ºåˆ°æœ¬åœ°ç›®å½•
          # LobeChat çš„ Dockerfile æœ€ç»ˆäº§ç‰©åœ¨ /app
          # æˆ‘ä»¬æŠŠé•œåƒé‡Œçš„æ–‡ä»¶ç³»ç»Ÿç›´æ¥ dump å‡ºæ¥
          docker buildx build \
             --platform linux/arm64 \
             --output type=tar,dest=./lobe-arm64.tar \
             .

      # 4. è§£åŒ…å¹¶é‡æ–°æ‰“åŒ… (ä¸ºäº†å‡å°ä½“ç§¯å’Œæ¸…ç†ç»“æ„)
      - name: Repackage
        run: |
          mkdir -p temp_extract
          tar -xf lobe-arm64.tar -C temp_extract
          
          mkdir -p final_package
          
          echo "ğŸ“‚ æå–æ ¸å¿ƒæ–‡ä»¶..."
          # Docker å¯¼å‡ºçš„ tar åŒ…å«æ•´ä¸ª Linux ç³»ç»Ÿç»“æ„
          # æˆ‘ä»¬åªéœ€è¦ /app ç›®å½•ä¸‹çš„å†…å®¹
          cp -r temp_extract/app/* final_package/
          
          # éªŒè¯ä¸€ä¸‹æ¶æ„ (ç¡®ä¿æ˜¯ ARM64)
          echo "ğŸ§ æ£€æŸ¥ sharp æ¶æ„..."
          file final_package/node_modules/sharp/build/Release/sharp-linux-arm64.node || echo "âš ï¸ æ²¡æ‰¾åˆ° sharp äºŒè¿›åˆ¶ï¼Œå¯èƒ½è·¯å¾„ä¸åŒ"

          echo "ğŸ“¦ æœ€ç»ˆå‹ç¼©..."
          cd final_package
          tar -czvf ../lobe-chat-termux-arm64.tar.gz .

      # 5. ä¸Šä¼ 
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lobe-chat-termux-arm64
          path: lobe-chat-termux-arm64.tar.gz
          retention-days: 3
